<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการร้าน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .status-button {
            transition: background-color 0.2s;
        }
        .status-button:hover {
            opacity: 0.8;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen items-center p-4">

    <!-- Header and Navigation -->
    <div class="w-full max-w-4xl text-center mb-6">
        <h1 class="text-4xl font-bold text-gray-800">แผงควบคุมร้านอาหาร</h1>
        <div class="mt-4 flex justify-center space-x-2 p-2 bg-white rounded-xl shadow-md fade-in">
            <button onclick="window.switchView('orders')" id="nav-orders" class="flex-1 text-center py-2 px-4 rounded-lg cursor-pointer hover:bg-red-100 font-semibold text-gray-600 transition-colors">
                จัดการคำสั่งซื้อ
            </button>
            <button onclick="window.switchView('add-menu')" id="nav-add-menu" class="flex-1 text-center py-2 px-4 rounded-lg cursor-pointer hover:bg-red-100 font-semibold text-gray-600 transition-colors">
                เพิ่มเมนู
            </button>
            <button onclick="window.switchView('view-menu')" id="nav-view-menu" class="flex-1 text-center py-2 px-4 rounded-lg cursor-pointer hover:bg-red-100 font-semibold text-gray-600 transition-colors">
                ดูเมนูทั้งหมด
            </button>
        </div>
    </div>

    <!-- Main Content Container -->
    <div id="main-content" class="w-full max-w-4xl flex-grow bg-white rounded-xl shadow-lg p-6 flex flex-col items-center relative">
        <!-- Content will be rendered here dynamically -->
    </div>

    <!-- Modal for viewing slip -->
    <div id="slip-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50 fade-in">
        <div class="bg-white rounded-xl p-4 max-w-2xl w-full">
            <div class="flex justify-end">
                <button onclick="window.closeModal('slip-modal')" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <h2 class="text-2xl font-bold mb-4">สลิปการชำระเงิน</h2>
            <div class="flex justify-center">
                <img id="modal-image" src="" alt="Payment Slip" class="max-w-full h-auto rounded-lg shadow-md">
            </div>
        </div>
    </div>

    <!-- Modal for editing menu item -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50 fade-in">
        <div class="bg-white rounded-xl p-6 max-w-xl w-full">
            <div class="flex justify-end">
                <button onclick="window.closeModal('edit-modal')" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <h2 class="text-2xl font-bold mb-4 text-center">แก้ไขเมนู</h2>
            <form id="edit-menu-form" class="space-y-4">
                <input type="hidden" id="edit-menu-id">
                <div>
                    <label for="edit-menu-name" class="block text-sm font-medium text-gray-700">ชื่อเมนู</label>
                    <input type="text" id="edit-menu-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                </div>
                <div>
                    <label for="edit-menu-price" class="block text-sm font-medium text-gray-700">ราคา</label>
                    <input type="number" id="edit-menu-price" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                </div>
                <div>
                    <label for="edit-menu-image" class="block text-sm font-medium text-gray-700">รูปภาพเมนูใหม่ (ถ้ามี)</label>
                    <input type="file" id="edit-menu-image" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
                </div>
                <div class="flex justify-between">
                    <button type="button" onclick="window.closeModal('edit-modal')" class="w-1/2 mr-2 py-2 px-4 rounded-md text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        ยกเลิก
                    </button>
                    <button type="submit" class="w-1/2 ml-2 py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        บันทึกการแก้ไข
                    </button>
                </div>
                <div id="edit-menu-status" class="text-center mt-4 hidden"></div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal for Deletion -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50 fade-in">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full text-center">
            <h3 class="text-xl font-bold mb-4">ยืนยันการลบเมนู</h3>
            <p class="mb-6 text-gray-700">คุณแน่ใจหรือไม่ว่าต้องการลบเมนูนี้? การกระทำนี้ไม่สามารถย้อนกลับได้</p>
            <div class="flex justify-between space-x-4">
                <button onclick="window.closeModal('confirm-modal')" class="w-full py-2 px-4 rounded-md text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300">
                    ยกเลิก
                </button>
                <button onclick="window.deleteConfirmed()" class="w-full py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700">
                    ยืนยัน
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, onSnapshot, collection, query, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment (DO NOT CHANGE)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization ---
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        let menuToDeleteId = null;

        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase initialized successfully.");
        } else {
            console.error("Firebase config is missing.");
        }

        // --- UI Elements and State ---
        const mainContent = document.getElementById('main-content');
        const slipModal = document.getElementById('slip-modal');
        const modalImage = document.getElementById('modal-image');
        const editModal = document.getElementById('edit-modal');
        const confirmModal = document.getElementById('confirm-modal');
        let currentView = 'orders';
        let unsubscribeOrders = null;
        let unsubscribeMenus = null;

        // --- View Rendering Functions ---
        function renderApp() {
            // Unsubscribe from all previous listeners
            if (unsubscribeOrders) {
                unsubscribeOrders();
                unsubscribeOrders = null;
            }
            if (unsubscribeMenus) {
                unsubscribeMenus();
                unsubscribeMenus = null;
            }

            // Reset navigation button styles
            const navButtons = document.querySelectorAll('.flex-1.py-2.px-4');
            navButtons.forEach(button => button.classList.remove('bg-red-500', 'text-white'));

            // Render the new view
            if (currentView === 'orders') {
                renderOrdersView();
                document.getElementById('nav-orders').classList.add('bg-red-500', 'text-white');
            } else if (currentView === 'add-menu') {
                renderAddMenuView();
                document.getElementById('nav-add-menu').classList.add('bg-red-500', 'text-white');
            } else if (currentView === 'view-menu') {
                renderMenusView();
                document.getElementById('nav-view-menu').classList.add('bg-red-500', 'text-white');
            }
        }

        function renderOrdersView() {
            mainContent.innerHTML = `
                <div id="loading-indicator" class="flex items-center justify-center p-12">
                    <div class="loader ease-linear rounded-full border-8 border-gray-200 h-24 w-24"></div>
                    <p class="mt-4 text-gray-500">กำลังโหลดคำสั่งซื้อ...</p>
                </div>
                <div id="orders-container" class="w-full space-y-6 hidden"></div>
                <div id="no-orders-message" class="text-center text-gray-500 mt-12 p-8 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p class="text-2xl font-semibold">ไม่มีคำสั่งซื้อเข้ามา</p>
                    <p class="mt-2 text-lg">รอลูกค้าสั่งอาหาร หรือลองเปลี่ยนโหมด</p>
                </div>
            `;
            fetchOrders();
        }

        function renderAddMenuView() {
            mainContent.innerHTML = `
                <div class="w-full p-6 space-y-6 fade-in">
                    <h2 class="text-2xl font-bold text-center text-gray-800">เพิ่มเมนูใหม่</h2>
                    <form id="add-menu-form" class="space-y-4">
                        <div>
                            <label for="menu-name" class="block text-sm font-medium text-gray-700">ชื่อเมนู</label>
                            <input type="text" id="menu-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="menu-price" class="block text-sm font-medium text-gray-700">ราคา</label>
                            <input type="number" id="menu-price" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="menu-image" class="block text-sm font-medium text-gray-700">รูปภาพเมนู</label>
                            <input type="file" id="menu-image" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100" required>
                        </div>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            เพิ่มเมนู
                        </button>
                    </form>
                    <div id="add-menu-status" class="text-center mt-4 hidden"></div>
                </div>
            `;
            const form = document.getElementById('add-menu-form');
            form.addEventListener('submit', handleAddMenuItem);
        }

        function renderMenusView() {
            mainContent.innerHTML = `
                <div id="loading-indicator" class="flex items-center justify-center p-12">
                    <div class="loader ease-linear rounded-full border-8 border-gray-200 h-24 w-24"></div>
                    <p class="mt-4 text-gray-500">กำลังโหลดเมนู...</p>
                </div>
                <div id="menus-container" class="w-full grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>
                <div id="no-menus-message" class="text-center text-gray-500 mt-12 p-8 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <p class="text-2xl font-semibold">ยังไม่มีเมนู</p>
                    <p class="mt-2 text-lg">ลองเพิ่มเมนูใหม่ในหน้า "เพิ่มเมนู"</p>
                </div>
            `;
            fetchMenus();
        }

        // --- Data Fetching and Rendering ---
        function fetchOrders() {
            if (!db) {
                console.error("Firestore not initialized.");
                return;
            }

            const ordersContainer = document.getElementById('orders-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const noOrdersMessage = document.getElementById('no-orders-message');

            loadingIndicator.classList.remove('hidden');
            ordersContainer.classList.add('hidden');
            noOrdersMessage.classList.add('hidden');

            const orderCollectionRef = collection(db, `artifacts/${appId}/public/data/orders`);
            const q = query(orderCollectionRef);

            unsubscribeOrders = onSnapshot(q, (snapshot) => {
                loadingIndicator.classList.add('hidden');
                ordersContainer.classList.remove('hidden');

                if (snapshot.empty) {
                    noOrdersMessage.classList.remove('hidden');
                    ordersContainer.innerHTML = '';
                    return;
                }

                noOrdersMessage.classList.add('hidden');
                ordersContainer.innerHTML = '';
                const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrders(orders, ordersContainer);
            }, (error) => {
                console.error("Error fetching orders:", error);
                loadingIndicator.classList.add('hidden');
                ordersContainer.innerHTML = `<div class="text-center text-red-500 mt-12 p-8">
                                                <p class="text-2xl font-semibold">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
                                                <p class="mt-2 text-lg">กรุณาลองใหม่อีกครั้งในภายหลัง</p>
                                            </div>`;
            });
        }

        function renderOrders(orders, container) {
            orders.sort((a, b) => b.timestamp - a.timestamp);
            orders.forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.className = "bg-white p-6 rounded-xl shadow-lg border border-gray-200 slide-up";
                orderElement.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">${order.customerName}</h2>
                            <p class="text-gray-500 text-sm">รหัสคำสั่งซื้อ: ${order.id}</p>
                            <p class="text-gray-500 text-sm">เวลา: ${new Date(order.timestamp).toLocaleString('th-TH')}</p>
                        </div>
                        <div class="mt-2 sm:mt-0 px-4 py-2 rounded-full text-sm font-semibold text-white ${getStatusColor(order.status)}">
                            ${getStatusText(order.status)}
                        </div>
                    </div>
                    <ul class="list-disc list-inside space-y-1 text-gray-700">
                        ${order.items.map(item => `
                            <li>${item.name} x ${item.quantity} - ${item.price} บาท</li>
                        `).join('')}
                    </ul>
                    <div class="text-right mt-4 font-bold text-lg text-gray-800">
                        รวม: ${order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0)} บาท
                    </div>
                    ${order.paymentSlipUrl ? `<div class="mt-4 text-center">
                        <button onclick="window.openModal('${order.paymentSlipUrl}', 'slip-modal')" class="text-sm font-medium text-red-600 hover:text-red-800 underline">ดูสลิปการชำระเงิน</button>
                    </div>` : ''}
                    <div class="flex flex-wrap gap-2 mt-6">
                        <button onclick="window.updateOrderStatus('${order.id}', 'pending')" class="status-button flex-1 py-2 px-4 rounded-lg bg-gray-200 text-gray-800 font-medium hover:bg-gray-300">รอยืนยัน</button>
                        <button onclick="window.updateOrderStatus('${order.id}', 'in_progress')" class="status-button flex-1 py-2 px-4 rounded-lg bg-yellow-400 text-yellow-900 font-medium hover:bg-yellow-500">กำลังทำ</button>
                        <button onclick="window.updateOrderStatus('${order.id}', 'out_for_delivery')" class="status-button flex-1 py-2 px-4 rounded-lg bg-blue-500 text-white font-medium hover:bg-blue-600">กำลังส่ง</button>
                        <button onclick="window.updateOrderStatus('${order.id}', 'delivered')" class="status-button flex-1 py-2 px-4 rounded-lg bg-green-500 text-white font-medium hover:bg-green-600">ส่งแล้ว</button>
                    </div>
                `;
                container.appendChild(orderElement);
            });
        }

        function fetchMenus() {
            if (!db) {
                console.error("Firestore not initialized.");
                return;
            }

            const menusContainer = document.getElementById('menus-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const noMenusMessage = document.getElementById('no-menus-message');

            loadingIndicator.classList.remove('hidden');
            menusContainer.classList.add('hidden');
            noMenusMessage.classList.add('hidden');

            const menuCollectionRef = collection(db, `artifacts/${appId}/public/data/menus`);
            const q = query(menuCollectionRef);

            unsubscribeMenus = onSnapshot(q, (snapshot) => {
                loadingIndicator.classList.add('hidden');
                menusContainer.classList.remove('hidden');

                if (snapshot.empty) {
                    noMenusMessage.classList.remove('hidden');
                    menusContainer.innerHTML = '';
                    return;
                }

                noMenusMessage.classList.add('hidden');
                menusContainer.innerHTML = '';
                const menus = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMenus(menus, menusContainer);
            }, (error) => {
                console.error("Error fetching menus:", error);
                loadingIndicator.classList.add('hidden');
                menusContainer.innerHTML = `<div class="text-center text-red-500 mt-12 p-8">
                                                <p class="text-2xl font-semibold">เกิดข้อผิดพลาดในการโหลดข้อมูลเมนู</p>
                                                <p class="mt-2 text-lg">กรุณาลองใหม่อีกครั้งในภายหลัง</p>
                                            </div>`;
            });
        }

        function renderMenus(menus, container) {
            menus.forEach(menu => {
                const menuElement = document.createElement('div');
                menuElement.className = "bg-white p-4 rounded-xl shadow-lg border border-gray-200 flex flex-col items-center text-center slide-up";
                menuElement.innerHTML = `
                    <img src="${menu.imageUrl}" alt="${menu.name}" class="w-full h-40 object-cover rounded-lg mb-4">
                    <h3 class="text-lg font-bold text-gray-800">${menu.name}</h3>
                    <p class="text-gray-600">${menu.price} บาท</p>
                    <div class="mt-4 flex space-x-2">
                        <button onclick="window.openEditModal('${menu.id}', '${menu.name}', '${menu.price}')" class="flex-1 py-2 px-4 rounded-md text-sm font-medium text-white bg-blue-500 hover:bg-blue-600">แก้ไข</button>
                        <button onclick="window.confirmDelete('${menu.id}')" class="flex-1 py-2 px-4 rounded-md text-sm font-medium text-white bg-red-500 hover:bg-red-600">ลบ</button>
                    </div>
                `;
                container.appendChild(menuElement);
            });
        }

        // --- Event Handlers and UI Logic ---
        window.switchView = function(viewName) {
            currentView = viewName;
            renderApp();
        }

        window.openModal = function(imageUrl, modalId) {
            if(modalId === 'slip-modal') {
                modalImage.src = imageUrl;
            }
            document.getElementById(modalId).classList.remove('hidden');
            document.getElementById(modalId).classList.add('flex');
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
            if (modalId === 'slip-modal') {
                modalImage.src = '';
            }
        }
        
        window.openEditModal = function(menuId, menuName, menuPrice) {
            const editForm = document.getElementById('edit-menu-form');
            editForm.reset();
            document.getElementById('edit-menu-id').value = menuId;
            document.getElementById('edit-menu-name').value = menuName;
            document.getElementById('edit-menu-price').value = menuPrice;
            document.getElementById('edit-menu-status').textContent = '';
            document.getElementById('edit-menu-status').classList.add('hidden');
            window.openModal(null, 'edit-modal');
        }

        window.confirmDelete = function(menuId) {
            menuToDeleteId = menuId;
            window.openModal(null, 'confirm-modal');
        }

        window.deleteConfirmed = async function() {
            if (menuToDeleteId) {
                await deleteMenuItem(menuToDeleteId);
                window.closeModal('confirm-modal');
                menuToDeleteId = null;
            }
        }

        window.updateOrderStatus = async function(orderId, newStatus) {
            if (!db) {
                console.error("Firestore not initialized.");
                return;
            }
            const orderDocRef = doc(db, `artifacts/${appId}/public/data/orders`, orderId);
            try {
                await updateDoc(orderDocRef, { status: newStatus });
                console.log("Order status updated successfully.");
            } catch (error) {
                console.error("Error updating order status: ", error);
            }
        }

        async function handleAddMenuItem(event) {
            event.preventDefault();
            if (!db) {
                console.error("Firestore not initialized.");
                return;
            }

            const menuName = document.getElementById('menu-name').value;
            const menuPrice = document.getElementById('menu-price').value;
            const menuImageFile = document.getElementById('menu-image').files[0];
            const statusMessage = document.getElementById('add-menu-status');

            if (!menuName || !menuPrice || !menuImageFile) {
                statusMessage.textContent = 'กรุณากรอกข้อมูลและเลือกรูปภาพให้ครบถ้วน';
                statusMessage.classList.remove('hidden', 'text-green-500', 'text-blue-500');
                statusMessage.classList.add('text-red-500', 'font-medium', 'block');
                return;
            }

            const FILE_SIZE_LIMIT = 500 * 1024; // 500 KB
            if (menuImageFile.size > FILE_SIZE_LIMIT) {
                statusMessage.textContent = `ไฟล์มีขนาดใหญ่เกินไป (สูงสุด 500 KB)`;
                statusMessage.classList.remove('text-green-500', 'text-blue-500');
                statusMessage.classList.add('text-red-500', 'font-medium', 'block');
                return;
            }

            statusMessage.textContent = 'กำลังอัปโหลด...';
            statusMessage.classList.remove('hidden', 'text-green-500', 'text-red-500');
            statusMessage.classList.add('text-blue-500', 'block');

            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const imageUrl = e.target.result;
                        await addDoc(collection(db, `artifacts/${appId}/public/data/menus`), {
                            name: menuName,
                            price: parseFloat(menuPrice),
                            imageUrl: imageUrl,
                            timestamp: Date.now()
                        });
                        statusMessage.textContent = 'เพิ่มเมนูเรียบร้อยแล้ว!';
                        statusMessage.classList.remove('text-blue-500');
                        statusMessage.classList.add('text-green-500', 'font-medium');
                        document.getElementById('add-menu-form').reset();
                    } catch (innerError) {
                        console.error("Error adding menu item:", innerError);
                        statusMessage.textContent = 'เกิดข้อผิดพลาดในการเพิ่มเมนู';
                        statusMessage.classList.remove('text-blue-500', 'text-green-500');
                        statusMessage.classList.add('text-red-500', 'font-medium');
                    }
                };
                reader.onerror = function(e) {
                    console.error("FileReader error:", e);
                    statusMessage.textContent = 'เกิดข้อผิดพลาดในการอ่านไฟล์';
                    statusMessage.classList.remove('text-blue-500', 'text-green-500');
                    statusMessage.classList.add('text-red-500', 'font-medium');
                };
                reader.readAsDataURL(menuImageFile);
            } catch (error) {
                console.error("Error during file read:", error);
                statusMessage.textContent = 'เกิดข้อผิดพลาดในการประมวลผลไฟล์';
                statusMessage.classList.remove('text-blue-500', 'text-green-500');
                statusMessage.classList.add('text-red-500', 'font-medium');
            }
        }

        // --- New Handlers for Edit and Delete ---
        async function handleEditMenuItem(event) {
            event.preventDefault();
            const menuId = document.getElementById('edit-menu-id').value;
            const menuName = document.getElementById('edit-menu-name').value;
            const menuPrice = document.getElementById('edit-menu-price').value;
            const menuImageFile = document.getElementById('edit-menu-image').files[0];
            const statusMessage = document.getElementById('edit-menu-status');
            
            const FILE_SIZE_LIMIT = 500 * 1024; // 500 KB
            if (menuImageFile && menuImageFile.size > FILE_SIZE_LIMIT) {
                statusMessage.textContent = `ไฟล์มีขนาดใหญ่เกินไป (สูงสุด 500 KB)`;
                statusMessage.classList.remove('hidden', 'text-green-500');
                statusMessage.classList.add('text-red-500', 'font-medium', 'block');
                return;
            }

            statusMessage.textContent = 'กำลังบันทึก...';
            statusMessage.classList.remove('hidden', 'text-red-500');
            statusMessage.classList.add('text-blue-500', 'font-medium', 'block');

            try {
                const menuDocRef = doc(db, `artifacts/${appId}/public/data/menus`, menuId);
                let updateData = {
                    name: menuName,
                    price: parseFloat(menuPrice)
                };

                if (menuImageFile) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        updateData.imageUrl = e.target.result;
                        await updateDoc(menuDocRef, updateData);
                        statusMessage.textContent = 'บันทึกเรียบร้อยแล้ว!';
                        statusMessage.classList.remove('text-blue-500');
                        statusMessage.classList.add('text-green-500');
                        setTimeout(() => window.closeModal('edit-modal'), 1500);
                    };
                    reader.onerror = function() {
                         statusMessage.textContent = 'เกิดข้อผิดพลาดในการอ่านไฟล์';
                         statusMessage.classList.remove('text-blue-500');
                         statusMessage.classList.add('text-red-500');
                    };
                    reader.readAsDataURL(menuImageFile);
                } else {
                    await updateDoc(menuDocRef, updateData);
                    statusMessage.textContent = 'บันทึกเรียบร้อยแล้ว!';
                    statusMessage.classList.remove('text-blue-500');
                    statusMessage.classList.add('text-green-500');
                    setTimeout(() => window.closeModal('edit-modal'), 1500);
                }

            } catch (error) {
                console.error("Error updating menu item:", error);
                statusMessage.textContent = 'เกิดข้อผิดพลาดในการบันทึกข้อมูล';
                statusMessage.classList.remove('text-blue-500');
                statusMessage.classList.add('text-red-500', 'font-medium');
            }
        }

        async function deleteMenuItem(menuId) {
            if (!db) {
                console.error("Firestore not initialized.");
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/menus`, menuId));
                console.log("Menu item deleted successfully.");
            } catch (error) {
                console.error("Error removing document: ", error);
            }
        }
        
        // Add event listener for the edit form
        document.getElementById('edit-menu-form').addEventListener('submit', handleEditMenuItem);


        // --- Helper functions ---
        function getStatusColor(status) {
            switch (status) {
                case 'pending': return 'bg-orange-500';
                case 'in_progress': return 'bg-yellow-500';
                case 'out_for_delivery': return 'bg-blue-500';
                case 'delivered': return 'bg-green-500';
                default: return 'bg-gray-500';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'pending': return 'รอยืนยัน';
                case 'in_progress': return 'กำลังทำ';
                case 'out_for_delivery': return 'กำลังส่ง';
                case 'delivered': return 'ส่งแล้ว';
                default: return 'ไม่ทราบสถานะ';
            }
        }
        
        // --- Initial Load ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                renderApp();
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    // Fallback to anonymous sign-in if custom token fails
                    await signInAnonymously(auth);
                }
            }
        });
    </script>
</body>
</html>
